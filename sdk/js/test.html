<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Backend JS SDK 测试页</title>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin: 20px; }
      h2 { margin-top: 28px; }
      fieldset { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
      legend { padding: 0 6px; color: #555; }
      label { display: block; margin: 8px 0 4px; }
      input[type="text"], input[type="password"], input[type="url"], input[type="number"], textarea, select {
        width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px;
      }
      button { padding: 8px 14px; border: 1px solid #1b73e8; background: #1b73e8; color: #fff; border-radius: 6px; cursor: pointer; }
      button.secondary { background: #fff; color: #1b73e8; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .actions { display: flex; gap: 8px; margin-top: 10px; }
      .output { white-space: pre-wrap; background: #0b1020; color: #e6edf3; padding: 12px; border-radius: 8px; overflow: auto; max-height: 40vh; }
      .muted { color: #6b7280; font-size: 12px; }
      .inline { display: inline-block; margin-right: 10px; }
      /* list render */
      .list { margin-top: 8px; padding: 8px; background: #f9fafb; border-radius: 6px; max-height: 30vh; overflow: auto; border: 1px solid #eee; }
      .item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
      .item code { background: #eef2ff; color: #1e3a8a; padding: 2px 6px; border-radius: 4px; }
      .badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; }
      .badge.public { background: #dcfce7; color: #166534; }
      .badge.private { background: #fef3c7; color: #92400e; }
    </style>
  </head>
  <body>
    <h1>Backend JS SDK 测试页</h1>
    <p class="muted">提示：请通过本地静态服务器访问此页面（避免 file:// 导致的 CORS/模块加载限制）。如：在仓库根目录执行 <code>python -m http.server 5173</code> 后访问 <code>http://localhost:5173/sdk/js/test.html</code>。</p>

    <fieldset>
      <legend>配置</legend>
      <label>Base URL（含协议和端口）：</label>
      <input id="baseURL" type="url" value="http://localhost:8080" />
      <div class="muted">后端默认端口为 <code>8080</code>，SDK 会自动拼接 <code>/api/v1</code>。</div>
      <label class="inline"><input id="autoRefresh" type="checkbox" checked /> 401 时自动刷新 Access Token</label>
      <div class="actions">
        <button id="initClient">初始化客户端</button>
        <button id="showTokens" class="secondary">查看当前 Tokens</button>
        <button id="clearTokens" class="secondary">清空 Tokens</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>认证</legend>
      <div class="row">
        <div>
          <label>用户名：</label>
          <input id="username" type="text" value="testuser" />
        </div>
        <div>
          <label>密码：</label>
          <input id="password" type="password" value="password123" />
        </div>
      </div>
      <div class="actions">
        <button id="login">传统登录（无设备验证）</button>
        <button id="refresh">刷新 Access Token</button>
        <button id="logout" class="secondary">登出</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>设备登录验证</legend>
      <div class="row">
        <div>
          <label>设备指纹（自动生成）：</label>
          <input id="deviceId" type="text" readonly placeholder="点击生成设备指纹..." />
          <button id="generateFingerprint" class="secondary">生成设备指纹</button>
          <div class="muted">基于浏览器特征自动生成，用于识别设备</div>
        </div>
        <div>
          <label>设备信息（自动检测）：</label>
          <input id="deviceName" type="text" readonly placeholder="设备名称" />
          <input id="deviceType" type="text" readonly placeholder="设备类型" />
          <button id="detectDevice" class="secondary">检测设备信息</button>
        </div>
      </div>
      
      <div class="row">
        <div>
          <label>第一步：设备登录（触发邮件验证）</label>
          <div class="actions">
            <button id="loginWithDevice">设备登录</button>
          </div>
          <div class="muted">首次登录陌生设备会发送邮件验证码</div>
        </div>
        <div>
          <label>第二步：验证码登录（完成验证）</label>
          <input id="deviceVerifyCode" type="text" placeholder="邮件验证码（6位数字）" maxlength="6" />
          <div class="actions">
            <button id="loginWithVerifyCode">提交验证码登录</button>
          </div>
          <div class="muted">输入邮件中的验证码完成设备验证</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>自定义设备登录：</label>
          <input id="customDeviceId" type="text" placeholder="自定义设备ID" />
          <input id="customDeviceName" type="text" placeholder="自定义设备名称" />
          <select id="customDeviceType">
            <option value="">选择设备类型</option>
            <option value="mobile">手机</option>
            <option value="tablet">平板</option>
            <option value="desktop">桌面</option>
          </select>
          <div class="actions">
            <button id="loginWithCustomDevice">自定义设备登录</button>
          </div>
        </div>
        <div>
          <label>测试流程：</label>
          <div class="actions">
            <button id="testDeviceFlow">完整测试流程</button>
            <button id="clearDeviceInputs" class="secondary">清空设备信息</button>
          </div>
          <div class="muted">自动执行：生成指纹 → 设备登录 → 等待验证码输入</div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>注册与密码</legend>
      <div class="row">
        <div>
          <label>发送注册验证码：</label>
          <input id="regUsername" type="text" placeholder="用户名 username" />
          <input id="regEmail" type="text" placeholder="邮箱 email" />
          <div class="actions"><button id="sendCode">POST /users/send-code</button></div>
        </div>
        <div>
          <label>注册：</label>
          <input id="regPassword" type="password" placeholder="密码 password" />
          <input id="regCode" type="text" placeholder="验证码 verification_code" />
          <input id="regNickname" type="text" placeholder="昵称(可选) nickname" />
          <input id="regAvatar" type="url" placeholder="头像URL(可选) avatar" />
          <textarea id="regBio" rows="2" placeholder="简介(可选) bio"></textarea>
          <div class="actions"><button id="register">POST /users/register</button></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>发送重置密码验证码：</label>
          <input id="resetEmail" type="text" placeholder="邮箱 email" />
          <div class="actions"><button id="sendResetCode">POST /users/send-reset-code</button></div>
        </div>
        <div>
          <label>重置密码：</label>
          <input id="resetNewPassword" type="password" placeholder="新密码 new_password" />
          <input id="resetCode" type="text" placeholder="验证码 verification_code" />
          <div class="actions"><button id="resetPassword">POST /users/reset-password</button></div>
        </div>
      </div>
    </fieldset>
    
    <fieldset>
      <legend>账号激活</legend>
      <div class="row">
        <div>
          <label>发送激活验证码：</label>
          <input id="activationEmail" type="text" placeholder="邮箱 email" />
          <div class="actions"><button id="sendActivationCode">POST /users/send-activation-code</button></div>
          <div class="muted">说明：未激活用户可用此功能；系统对发送频率做了 IP 限流</div>
        </div>
        <div>
          <label>激活账号：</label>
          <input id="activationCode" type="text" placeholder="验证码 verification_code" maxlength="6" />
          <div class="actions"><button id="activateAccount">POST /users/activate</button></div>
          <div class="muted">提示：验证码 5 分钟有效，成功激活后验证码将被删除</div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>用户</legend>
      <div class="actions">
        <button id="getMe">获取当前用户（鉴权）</button>
      </div>
      <div class="row">
        <div>
          <label>通过 ID 获取：</label>
          <input id="userId" type="text" placeholder="用户ID" />
          <button id="getById">GET /users/{id}</button>
        </div>
        <div>
          <label>通过用户名获取：</label>
          <input id="userNameQuery" type="text" placeholder="用户名" />
          <button id="getByUsername">GET /users/username/{username}</button>
        </div>
      </div>
      <label>更新当前用户：</label>
      <div class="row">
        <div>
          <input id="nickname" type="text" placeholder="nickname" />
        </div>
        <div>
          <input id="avatar" type="url" placeholder="avatar url" />
        </div>
      </div>
      <textarea id="bio" rows="2" placeholder="bio"></textarea>
      <div class="actions"><button id="updateMe">PUT /users/me</button></div>
    </fieldset>

    <fieldset>
      <legend>文件</legend>
      <div class="row">
        <div>
          <label>公开文件列表：</label>
          <div class="actions">
            <button id="listPublic">GET /files/public</button>
          </div>
          <div id="publicFilesList" class="list"></div>
        </div>
        <div>
          <label>我的文件列表（鉴权）：</label>
          <div class="actions">
            <button id="listMy">GET /files/my</button>
          </div>
          <div id="myFilesList" class="list"></div>
        </div>
      </div>

      <label>获取/更新/删除文件（需要文件ID）：</label>
      <div class="row">
        <div>
          <input id="fileId" type="text" placeholder="文件ID" />
          <div class="actions">
            <button id="getFile">GET /files/{id}</button>
            <button id="deleteFile" class="secondary">DELETE /files/{id}</button>
          </div>
        </div>
        <div>
          <input id="fileCategory" type="text" placeholder="category" />
          <input id="fileDesc" type="text" placeholder="description" />
          <label class="inline"><input id="filePublic" type="checkbox" /> is_public</label>
          <div class="actions"><button id="updateFile">PUT /files/{id}</button></div>
        </div>
      </div>

      <label>上传文件（鉴权）：</label>
      <div class="row">
        <div>
          <div class="muted">单文件上传</div>
          <input id="singleFile" type="file" />
          <input id="singleCategory" type="text" placeholder="category" />
          <input id="singleDesc" type="text" placeholder="description" />
          <input id="singleStorage" type="text" placeholder="storage_name(可选)" />
          <label class="inline"><input id="singlePublic" type="checkbox" /> is_public</label>
          <div class="actions"><button id="uploadSingle">POST /files/upload</button></div>
        </div>
        <div>
          <div class="muted">多文件上传</div>
          <input id="multiFiles" type="file" multiple />
          <input id="multiCategory" type="text" placeholder="category" />
          <input id="multiDesc" type="text" placeholder="description" />
          <input id="multiStorage" type="text" placeholder="storage_name(可选)" />
          <label class="inline"><input id="multiPublic" type="checkbox" /> is_public</label>
          <div class="actions"><button id="uploadMulti">POST /files/upload-multiple</button></div>
        </div>
      </div>

      <div class="actions">
        <button id="getStorages">GET /files/storages</button>
      </div>
    </fieldset>

    <fieldset>
      <legend>好友</legend>
      <div class="row">
        <div>
          <label>发起好友请求（鉴权）：</label>
          <input id="createFriendRequestReceiverId" type="text" placeholder="对方用户ID receiver_id" />
          <input id="createFriendRequestNote" type="text" placeholder="申请备注(可选) note" />
          <div class="actions">
            <button id="createFriendRequest">POST /friends/requests</button>
          </div>
        </div>
        <div>
          <label>处理请求：</label>
          <input id="friendRequestId" type="text" placeholder="请求ID id" />
          <div class="actions">
            <button id="acceptFriendRequest">POST /friends/requests/{id}/accept</button>
            <button id="rejectFriendRequest" class="secondary">POST /friends/requests/{id}/reject</button>
            <button id="cancelFriendRequest" class="secondary">DELETE /friends/requests/{id}</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>好友列表（鉴权）：</label>
          <input id="friendPage" type="number" placeholder="page" value="1" />
          <input id="friendLimit" type="number" placeholder="limit" value="20" />
          <input id="friendSearch" type="text" placeholder="搜索(可选) search" />
          <div class="actions">
            <button id="listFriends">GET /friends/list</button>
          </div>
        </div>
        <div>
          <label>请求列表（鉴权）：</label>
          <select id="incomingStatus">
            <option value="">入站状态(可选)</option>
            <option value="pending">pending</option>
            <option value="accepted">accepted</option>
            <option value="rejected">rejected</option>
            <option value="canceled">canceled</option>
          </select>
          <div class="actions">
            <button id="listIncoming">GET /friends/requests/incoming</button>
          </div>
          <select id="outgoingStatus">
            <option value="">出站状态(可选)</option>
            <option value="pending">pending</option>
            <option value="accepted">accepted</option>
            <option value="rejected">rejected</option>
            <option value="canceled">canceled</option>
          </select>
          <div class="actions">
            <button id="listOutgoing">GET /friends/requests/outgoing</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>好友操作：</label>
          <input id="friendFriendId" type="text" placeholder="好友ID friend_id" />
          <input id="friendRemark" type="text" placeholder="备注 remark" />
          <div class="actions">
            <button id="updateRemarkFriend">PATCH /friends/remarks/{friend_id}</button>
            <button id="deleteFriend" class="secondary">DELETE /friends/{friend_id}</button>
          </div>
        </div>
        <div>
          <label>黑名单：</label>
          <input id="blockUserId" type="text" placeholder="用户ID user_id" />
          <div class="actions">
            <button id="blockUser">POST /friends/blocks/{user_id}</button>
            <button id="unblockUser" class="secondary">DELETE /friends/blocks/{user_id}</button>
            <button id="listBlocks" class="secondary">GET /friends/blocks</button>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>聊天（WebSocket，一对一、好友校验、room_id）</legend>
      <div class="row">
        <div>
          <label>连接状态：<span id="chatStatus">未连接</span></label>
          <div class="actions">
            <button id="chatConnect">连接 WS</button>
            <button id="chatDisconnect" class="secondary">断开 WS</button>
          </div>
          <div class="muted">说明：SDK 自动通过 query token 进行鉴权，例如 ?token=ACCESS_TOKEN</div>
        </div>
        <div>
          <label>发送消息：</label>
          <input id="chatToUserId" type="text" placeholder="对方用户ID to_user_id（与 room_id 二选一）" />
          <input id="chatRoomId" type="text" placeholder="房间ID room_id（优先使用）" />
          <input id="chatMessage" type="text" placeholder="消息内容 content" />
          <div class="actions">
            <button id="chatSend">发送</button>
          </div>
          <div class="muted">首次与好友发送将自动创建/恢复房间；服务端回包附带 room_id，页面会自动填充</div>
        </div>
      </div>
    </fieldset>

    <h2>输出</h2>
    <div id="output" class="output"></div>

    <script type="module" src="./test-page.js"></script>
  </body>
</html>
